# Docker Compose configuration for production environment
# Use with: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

version: '3.8'

services:
  app:
    environment:
      # Production-specific settings
      - DEBUG=false
      - ENVIRONMENT=production
      - LOG_LEVEL=WARNING
      - RELOAD=false
      # Security settings
      - CORS_ORIGINS=["https://yourdomain.com"]
    # Remove development volumes
    volumes:
      - app_logs:/app/logs
      - ./config:/app/config:ro
    # Production resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  db:
    environment:
      # Production PostgreSQL settings
      - POSTGRES_SHARED_BUFFERS=512MB
      - POSTGRES_EFFECTIVE_CACHE_SIZE=2GB
      - POSTGRES_MAINTENANCE_WORK_MEM=128MB
    # Don't expose PostgreSQL port in production
    ports: []
    # Production resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  # Remove adminer in production
  adminer:
    profiles:
      - never