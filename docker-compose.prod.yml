version: '3.8'

# 本番環境用のDocker Compose設定
# 使用方法: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  app:
    build:
      target: production
    environment:
      - DEBUG=false
      - ENVIRONMENT=production
      - LOG_LEVEL=WARNING
      - SKIP_MIGRATIONS=false
      - CREATE_SAMPLE_DATA=false
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 60s

  db:
    environment:
      - POSTGRES_USER=todouser
      - POSTGRES_PASSWORD=${DB_PASSWORD:-todopass}
      - POSTGRES_DB=todoapp
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    # 本番環境ではポートを公開しない
    ports: []
    
  # 本番環境ではAdminerを無効化
  adminer:
    profiles:
      - debug