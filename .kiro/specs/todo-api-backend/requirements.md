# 要件定義書

## 概要

Windows11のローカル環境でDockerを使用して動作するToDoアプリケーションのバックエンドAPIを開発する。Python 3.13とFastAPIを使用してRESTful APIを構築し、PostgreSQL 17.5でデータを永続化する。ユーザーはSwagger UIを通じてAPIの動作確認を行うことができる。

## 要件

### 要件 1: ToDoアイテムの基本CRUD操作

**ユーザーストーリー:** 開発者として、ToDoアイテムの作成、読み取り、更新、削除ができるAPIエンドポイントが欲しい。これにより基本的なToDoアプリケーションの機能を提供できる。

#### 受け入れ基準

1. WHEN ユーザーがPOST /todosエンドポイントに有効なToDoデータを送信する THEN システムは新しいToDoアイテムを作成し、201ステータスコードとともに作成されたアイテムを返す
2. WHEN ユーザーがGET /todosエンドポイントにリクエストを送信する THEN システムはすべてのToDoアイテムのリストを200ステータスコードとともに返す
3. WHEN ユーザーがGET /todos/{id}エンドポイントに有効なIDを送信する THEN システムは指定されたToDoアイテムを200ステータスコードとともに返す
4. WHEN ユーザーがPUT /todos/{id}エンドポイントに有効なIDと更新データを送信する THEN システムはToDoアイテムを更新し、200ステータスコードとともに更新されたアイテムを返す
5. WHEN ユーザーがDELETE /todos/{id}エンドポイントに有効なIDを送信する THEN システムはToDoアイテムを削除し、204ステータスコードを返す

### 要件 2: データモデルとバリデーション

**ユーザーストーリー:** 開発者として、ToDoアイテムが適切な構造とバリデーションを持つことで、データの整合性を保ちたい。

#### 受け入れ基準

1. WHEN ToDoアイテムが作成される THEN システムはタイトル（必須、最大200文字）、説明（任意、最大1000文字）、完了状態（デフォルトfalse）、作成日時、更新日時を含む
2. WHEN 無効なデータでToDoアイテムの作成または更新が試行される THEN システムは422ステータスコードとともに詳細なバリデーションエラーメッセージを返す
3. WHEN 存在しないIDでToDoアイテムの取得、更新、削除が試行される THEN システムは404ステータスコードとともに適切なエラーメッセージを返す

### 要件 3: データベース統合

**ユーザーストーリー:** 開発者として、ToDoデータがPostgreSQLデータベースに永続化されることで、アプリケーションの再起動後もデータが保持されることを確認したい。

#### 受け入れ基準

1. WHEN アプリケーションが起動する THEN システムはPostgreSQLデータベースに接続し、必要なテーブルを自動作成する
2. WHEN ToDoアイテムが作成、更新、削除される THEN システムは変更をPostgreSQLデータベースに永続化する
3. WHEN データベース接続エラーが発生する THEN システムは適切なエラーハンドリングを行い、500ステータスコードとともにエラーメッセージを返す

### 要件 4: Docker環境での実行

**ユーザーストーリー:** 開発者として、Dockerを使用してアプリケーションとデータベースを簡単に起動できることで、環境構築の手間を省きたい。

#### 受け入れ基準

1. WHEN 開発者がdocker-compose upコマンドを実行する THEN システムはFastAPIアプリケーションとPostgreSQLデータベースの両方を起動する
2. WHEN アプリケーションが起動する THEN システムはhttp://localhost:8000でAPIエンドポイントにアクセス可能にする
3. WHEN アプリケーションが起動する THEN システムはhttp://localhost:8000/docsでSwagger UIにアクセス可能にする

### 要件 5: API仕様とドキュメント

**ユーザーストーリー:** 開発者として、Swagger UIを通じてAPIの仕様を確認し、実際にAPIをテストできることで、開発効率を向上させたい。

#### 受け入れ基準

1. WHEN ユーザーがSwagger UIにアクセスする THEN システムはすべてのAPIエンドポイントの詳細な仕様を表示する
2. WHEN ユーザーがSwagger UIからAPIエンドポイントをテストする THEN システムは実際のAPIリクエストを実行し、レスポンスを表示する
3. WHEN APIエンドポイントが呼び出される THEN システムは適切なHTTPステータスコードとJSON形式のレスポンスを返す

### 要件 6: テスト環境

**ユーザーストーリー:** 開発者として、単体テストを実行してコードの品質を保証したい。

#### 受け入れ基準

1. WHEN 開発者がテストコマンドを実行する THEN システムはすべての単体テストを実行し、結果を表示する
2. WHEN テストが実行される THEN システムはAPIエンドポイント、データモデル、データベース操作の各機能をテストする
3. WHEN テストデータベースが必要な場合 THEN システムは本番データベースとは分離されたテスト用データベースを使用する

### 要件 7: ToDoアイテムの期限設定機能

**ユーザーストーリー:** ユーザーとして、ToDoアイテムに期限（end_date）を設定できることで、タスクの優先度管理と期限切れの把握ができるようになりたい。

#### 受け入れ基準

1. WHEN ユーザーがToDoアイテムを作成する際にend_dateフィールドを指定する THEN システムは期限付きのToDoアイテムを作成し、ISO 8601形式の日時として保存する
2. WHEN ユーザーがToDoアイテムを作成する際にend_dateフィールドを指定しない THEN システムは期限なしのToDoアイテムを作成し、end_dateフィールドをnullとして保存する
3. WHEN ユーザーが既存のToDoアイテムにend_dateを追加または更新する THEN システムは指定された期限を設定し、更新されたアイテムを返す
4. WHEN ユーザーが既存のToDoアイテムからend_dateを削除する（nullに設定）THEN システムは期限を削除し、end_dateフィールドをnullに設定する
5. WHEN システムがToDoアイテムの期限切れ状態を判定する THEN システムは現在日時とend_dateを比較し、期限切れの場合はis_overdueプロパティでtrueを返す
6. WHEN 完了済みのToDoアイテムの期限切れ状態を判定する THEN システムは完了済みアイテムを期限切れとして扱わない（is_overdue = false）
7. WHEN 無効な日時形式でend_dateが指定される THEN システムは422ステータスコードとともにバリデーションエラーメッセージを返す

### 要件 8: 条件付きToDoアイテム検索機能

**ユーザーストーリー:** ユーザーとして、完了状態や期限日で絞り込んだToDoアイテムを取得できることで、効率的なタスク管理ができるようになりたい。

#### 受け入れ基準

1. WHEN ユーザーがGET /todos/searchエンドポイントにcompletedパラメータを指定する THEN システムは指定された完了状態のToDoアイテムのみを200ステータスコードとともに返す
2. WHEN ユーザーがGET /todos/searchエンドポイントにend_date_fromパラメータを指定する THEN システムは指定された日時以降に期限が設定されたToDoアイテムを返す
3. WHEN ユーザーがGET /todos/searchエンドポイントにend_date_toパラメータを指定する THEN システムは指定された日時以前に期限が設定されたToDoアイテムを返す
4. WHEN ユーザーがGET /todos/searchエンドポイントに複数の検索条件を指定する THEN システムはすべての条件を満たすToDoアイテムを返す
5. WHEN ユーザーがGET /todos/searchエンドポイントにパラメータを指定しない THEN システムはすべてのToDoアイテムを返す
6. WHEN ユーザーが無効な日時形式でend_date_fromまたはend_date_toを指定する THEN システムは422ステータスコードとともにバリデーションエラーメッセージを返す
7. WHEN ユーザーが無効なboolean値でcompletedパラメータを指定する THEN システムは422ステータスコードとともにバリデーションエラーメッセージを返す
8. WHEN ユーザーがend_date_fromがend_date_toより後の日時を指定する THEN システムは422ステータスコードとともに適切なエラーメッセージを返す

### 要件 9: プロジェクトドキュメント

**ユーザーストーリー:** 開発者として、各機能の動作フローを視覚的に理解できるシーケンス図があることで、システムの理解と保守性を向上させたい。

#### 受け入れ基準

1. WHEN プロジェクトドキュメントが作成される THEN システムはPlantUMLを使用してToDoアイテムのCRUD操作のシーケンス図を含む
2. WHEN シーケンス図が作成される THEN システムはクライアント、FastAPI、PostgreSQLの間の相互作用を明確に示す
3. WHEN ドキュメントが更新される THEN システムは各APIエンドポイントの処理フローを個別のシーケンス図として提供する