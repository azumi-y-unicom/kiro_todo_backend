@startuml delete_todo
title ToDoアイテム削除シーケンス

actor Client as C
participant "FastAPI\n(Router)" as API
participant "TodoService\n(Business Logic)" as Service
participant "TodoRepository\n(Data Access)" as Repo
database "PostgreSQL\n(Database)" as DB

C -> API: DELETE /todos/id
activate API

API -> API: Path parameter validation\n(id: int)
note right: Path parameter\ntype checking

API -> Service: delete_todo(todo_id)
activate Service

Service -> Repo: get_by_id(todo_id)
activate Repo
Repo -> DB: SELECT * FROM todos\nWHERE id = todo_id
activate DB
DB --> Repo: Existing Todo record
deactivate DB
Repo --> Service: TodoModel
deactivate Repo

note right of Service: Check existence before deletion

Service -> Repo: delete(todo_id)
activate Repo

Repo -> DB: DELETE FROM todos\nWHERE id = todo_id
activate DB
DB --> Repo: Delete success (affected rows: 1)
deactivate DB

Repo --> Service: Delete success
deactivate Repo

Service --> API: Delete success
deactivate Service

API --> C: 204 No Content
deactivate API

note over C, DB: Success: Todo item deleted successfully

== Todo Not Found Case ==

C -> API: DELETE /todos/non_existent_id
activate API
API -> Service: delete_todo(non_existent_id)
activate Service
Service -> Repo: get_by_id(non_existent_id)
activate Repo
Repo -> DB: SELECT * FROM todos\nWHERE id = non_existent_id
activate DB
DB --> Repo: None (no record)
deactivate DB
Repo --> Service: None
deactivate Repo
Service --> API: HTTPException(404)
deactivate Service
API --> C: 404 Not Found\n"detail: Todo not found"
deactivate API

== Invalid ID Case ==

C -> API: DELETE /todos/invalid_id
activate API
API -> API: Path parameter validation error
API --> C: 422 Unprocessable Entity\nvalidation errors
deactivate API

== Database Error Case ==

C -> API: DELETE /todos/id
activate API
API -> Service: delete_todo(todo_id)
activate Service
Service -> Repo: get_by_id(todo_id)
activate Repo
Repo -> DB: SELECT query
activate DB
DB --> Repo: TodoModel
deactivate DB
Repo --> Service: TodoModel
deactivate Repo
Service -> Repo: delete(todo_id)
activate Repo
Repo -> DB: DELETE query
activate DB
DB --> Repo: Database error
deactivate DB
Repo --> Service: Exception
deactivate Repo
Service --> API: Exception
deactivate Service
API --> C: 500 Internal Server Error\nerror message
deactivate API

@enduml