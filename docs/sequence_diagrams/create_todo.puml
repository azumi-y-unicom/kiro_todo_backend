@startuml create_todo
title ToDoアイテム作成シーケンス

actor Client as C
participant "FastAPI\n(Router)" as API
participant "TodoService\n(Business Logic)" as Service
participant "TodoRepository\n(Data Access)" as Repo
database "PostgreSQL\n(Database)" as DB

C -> API: POST /todos\n{title, description, completed}
activate API

API -> API: Request validation\n(Pydantic schema)
note right: TodoCreateスキーマで\nバリデーション実行

API -> Service: create_todo(todo_data)
activate Service

Service -> Service: Business logic validation
note right: タイトル長さチェック\n説明文字数チェック

Service -> Repo: create(todo_data)
activate Repo

Repo -> DB: INSERT INTO todos\n(title, description, completed, created_at, updated_at)
activate DB
DB --> Repo: 新しいToDoレコード
deactivate DB

Repo --> Service: TodoModel
deactivate Repo

Service --> API: TodoModel
deactivate Service

API -> API: Response serialization\n(TodoResponse schema)
API --> C: 201 Created\n{id, title, description, completed, created_at, updated_at}
deactivate API

note over C, DB: 正常系: ToDoアイテムが正常に作成される

== エラーケース ==

C -> API: POST /todos\n{invalid_data}
activate API
API -> API: Validation error
API --> C: 422 Unprocessable Entity\n{validation errors}
deactivate API

C -> API: POST /todos\n{valid_data}
activate API
API -> Service: create_todo(todo_data)
activate Service
Service -> Repo: create(todo_data)
activate Repo
Repo -> DB: INSERT query
activate DB
DB --> Repo: Database error
deactivate DB
Repo --> Service: Exception
deactivate Repo
Service --> API: Exception
deactivate Service
API --> C: 500 Internal Server Error\n{error message}
deactivate API

@enduml