# Full-featured Docker Compose configuration with all production settings
# Use with: docker-compose -f docker-compose.full.yml up

version: '3.8'

services:
  app:
    build: 
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: todo-api-app
    ports:
      - "8000:8000"
    environment:
      # Database Configuration
      - DATABASE_URL=postgresql://todouser:todopass@db:5432/todoapp
      - DATABASE_POOL_SIZE=5
      - DATABASE_MAX_OVERFLOW=10
      - DATABASE_POOL_TIMEOUT=30
      - DATABASE_POOL_RECYCLE=300
      
      # Application Configuration
      - APP_NAME=Todo API Backend
      - APP_VERSION=1.0.0
      - DEBUG=false
      - ENVIRONMENT=production
      
      # Server Configuration
      - HOST=0.0.0.0
      - PORT=8000
      - RELOAD=false
      
      # Logging Configuration
      - LOG_LEVEL=INFO
      - LOG_FORMAT=%(asctime)s - %(name)s - %(levelname)s - %(message)s
      
      # API Configuration
      - DOCS_URL=/docs
      - REDOC_URL=/redoc
      - OPENAPI_URL=/openapi.json
      
      # CORS Configuration
      - CORS_ORIGINS=["http://localhost:3000", "http://localhost:8080"]
      - CORS_ALLOW_CREDENTIALS=true
      - CORS_ALLOW_METHODS=["GET", "POST", "PUT", "DELETE", "OPTIONS"]
      - CORS_ALLOW_HEADERS=["*"]
      
      # Pagination Configuration
      - DEFAULT_PAGE_SIZE=100
      - MAX_PAGE_SIZE=1000
    volumes:
      - app_logs:/app/logs
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - todo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  db:
    image: postgres:17.5-alpine
    container_name: todo-api-db
    environment:
      - POSTGRES_USER=todouser
      - POSTGRES_PASSWORD=todopass
      - POSTGRES_DB=todoapp
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256 --auth-local=scram-sha-256 --locale=C --lc-collate=C --lc-ctype=en_US.utf8
      - LC_ALL=C.UTF-8
      - LANG=C.UTF-8
      - POSTGRES_SHARED_PRELOAD_LIBRARIES=pg_stat_statements
      - POSTGRES_MAX_CONNECTIONS=100
      - POSTGRES_SHARED_BUFFERS=256MB
      - POSTGRES_EFFECTIVE_CACHE_SIZE=1GB
      - POSTGRES_MAINTENANCE_WORK_MEM=64MB
      - POSTGRES_CHECKPOINT_COMPLETION_TARGET=0.9
      - POSTGRES_WAL_BUFFERS=16MB
      - POSTGRES_DEFAULT_STATISTICS_TARGET=100
    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./db/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U todouser -d todoapp -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - todo-network
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  adminer:
    image: adminer:4.8.1
    container_name: todo-api-adminer
    ports:
      - "8080:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=db
      - ADMINER_DESIGN=pepa-linha
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - todo-network
    profiles:
      - admin

volumes:
  postgres_data:
    driver: local
  postgres_config:
    driver: local
  postgres_backup:
    driver: local
  app_logs:
    driver: local

networks:
  todo-network:
    driver: bridge
    name: todo-api-network
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: todo-api-br0
      com.docker.network.driver.mtu: 1500